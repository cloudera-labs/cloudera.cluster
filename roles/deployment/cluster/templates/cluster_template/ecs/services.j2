{% import 'cm_api.j2' as cm_api with context %}
{
  "items": [
  {%- set service_joiner = joiner(",") -%}
  {%- for service in cluster.services -%}
  {%- set service_role_types = role_mappings[service] -%}
  {{ service_joiner() }}
  {
    {%- set service_type = service -%}
    {%- set service_name = service | lower -%}
    "name": "{{ service_name }}",
    "displayName": "{{ service_type | replace("_", " ") }}",
    "serviceType": "{{ service_type }}",
    {% set config_sep = joiner(",") -%}
    "serviceConfigs": {{ cm_api.ApiClusterTemplateConfigList(merged_configs, service, 'SERVICEWIDE') }},
    "roles": [
      {% set role_sep = joiner(",") -%}
      {%- for (template_name, role_mapping) in cluster.host_templates.items() -%}
        {%- for (template_service, roles) in role_mapping.items() -%}
        {%- if template_service == service -%}
          {%- for role in roles -%}
            {%- for host in groups[template_name] -%}
              {{ role_sep() }}
              {
                "type": "{{ role }}"
                "hostRef" : {
                  "hostId" : "{{ cloudera_manager_api_hosts[host]['id'] }}"
                },
                "roleConfigGroupRef" : {
                  "roleConfigGroupName" : "{{ service_nam }}-{{ role }}-BASE"
                }
              }
            {%- endfor -%}
          {%- endfor -%}
        {%- endif -%}
      {%- endfor -%}
    ]
    "roleConfigGroups": [
      {%- set role_group_sep = joiner(",") -%}
      {%- if service_role_types is iterable -%}
        {%- for role_type in service_role_types -%}
          {{ role_group_sep() }}
          {
            "refName": "{{ service_ref }}-{{ role_type }}-BASE",
            "roleType": "{{ role_type }}",
            {% set config_sep = joiner(",") -%}
            "configs": {{ cm_api.ApiClusterTemplateConfigList(merged_configs, service, role_type) }},
            "base": true
          }
        {%- endfor -%}
      {%- endif -%}
    ]
  }
  {%- endfor -%}
]}




{
  "items": [{
    "name": "{{ kms_service_name }}",
    "displayName": "{{ kms_display_name }}",
    "type": "{{ kms_service_type }}",
    "config": {{ cm_api.ApiConfigList(merged_configs['SERVICEWIDE']) }},
    "roles": [
    {%- set role_joiner = joiner(",") -%}
    {%- for kms_server in groups.kms_servers -%}
    {{ role_joiner() }}
      {
        "type" : "{{ kms_role_type }}",
        "hostRef" : {
          "hostId" : "{{ cloudera_manager_api_hosts[kms_server]['id'] }}"
        },
        "roleConfigGroupRef" : {
          "roleConfigGroupName" : "{{ kms_service_name }}-{{ kms_role_type }}-BASE"
        }
      }
    {%- endfor -%}
    ],
    "roleConfigGroups": [
      {
        "name": "{{ kms_service_name }}-{{ kms_role_type }}-BASE",
        "roleType": "{{ kms_role_type }}",
        "base": true,
        "config": {{ cm_api.ApiConfigList(merged_configs[kms_role_type]) }}
      }
    ]
  }
]}
