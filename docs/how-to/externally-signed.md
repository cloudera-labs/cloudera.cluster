# How to: Setup externally signed TLS certificates

The playbook is able to provision an internal CA and automatically sign the host certificates.

However, it is more likely that an external CA will be used in production environments.

This guide will run through specifics for deploying clusters using an external CA to sign the host certificates.

At a high-level, the playbook generates and distributes the TLS keys and certificates in three steps:

- Phase 1 (generation)
  * Create the host keys
  * Generate the keystores
  * Generate the CSRs
  * Copy the CSRs to the Ansible controller
- Phase 2 (signing)
  * Sign the certificates
- Phase 3 (installation)
  * Copy the signed certificates to the hosts
  * Copy the CA certificates to the hosts

When `ca_server` is used, this all occurs automatically.

However, when an external CA is used, a few manual steps are required to complete the deployment:

Starting with the definition, assuming nothing has been deployed:

## Ensure that `ca_server` is **not** present in the inventory

The `ca_server` is the playbook's internal CA.

As we wish to use an external CA, it should be omitted from the inventory file.

## Set `tls_ca_certs` to point to the external CA certificates

Here, we need to set `tls_ca_certs` in `extra_vars.yml` to point to the external CA certificates (on the Ansible controller):

```
tls_ca_certs:
  - alias: ipaca
    path: /root/ca.crt
```

In this example, our CA certificate exists on the Ansible controller at `/root/ca.crt`.

**Note:** If you have an intermediate CA and a root CA, please include both certificates here.

## Run the playbook deployment as usual

If everything is configured correctly, it should run as usual until we reach `prepare_tls.yml`.

Here, in `prepare_tls.yml`, it will fail with a message:

> Signed cert for <hostname> could not be found. If manual signing is required, do this now and re-run the playbook with 'tls_signed_certs_dir' variable set.

E.g.

```
TASK [security/tls_install_certs : fail] **************************************************************************************************************
fatal: [host-1.example.com] FAILED! => {"changed": false, "msg": "\"Signed cert for host-1.example.com could not be found. If manual signing is required, do this now and re-run the playbook with 'tls_signed_certs_dir' variable set.\n"}
fatal: [host-2.example.com] FAILED! => {"changed": false, "msg": "\"Signed cert for host-1.example.com could not be found. If manual signing is required, do this now and re-run the playbook with 'tls_signed_certs_dir' variable set.\n"}
fatal: [host-3.example.com] FAILED! => {"changed": false, "msg": "\"Signed cert for host-1.example.com could not be found. If manual signing is required, do this now and re-run the playbook with 'tls_signed_certs_dir' variable set.\n"}
fatal: [host-4.example.com] FAILED! => {"changed": false, "msg": "\"Signed cert for host-1.example.com could not be found. If manual signing is required, do this now and re-run the playbook with 'tls_signed_certs_dir' variable set.\n"}
```

This is expected.

At this point, the playbook will have generated the TLS keys and CSRs and copied the CSRs to the Ansible controller (stage 1).

It is up to us now to sign the CSRs and copy the signed certificates back to the Ansible controller:

## Sign the CSRs generated by the playbook

You will find copies of the TLS CSRs in `{{ local_temp_dir }}/csrs` on the Ansible controller (default `/tmp/csrs`).

```
# ls /tmp/csrs
host-1.example.com.csr  host-3.example.com.csr
host-2.example.com.csr  host-4.example.com.csr
```

Sign the CSRs and copy the signed certificates to the Ansible controller using the same filename, replacing `.csr` with `.pem`.

Place these signed certificates in `{{ local_temp_dir }}/certs` on the Ansible controller (default `/tmp/certs`).

```
# ls /tmp/certs
host-1.example.com.pem  host-3.example.com.pem
host-2.example.com.pem  host-4.example.com.pem
```

## Rerun the playbook

The playbook can be restarted now that the signed certificates exist on the Ansible controller (stage 2).

**Note:** To save time, you can start the playbook from `prepare_tls.yml` â€“ skipping completed steps.

The playbook will distribute the new signed certificates and continue as usual.

No other steps are required.
